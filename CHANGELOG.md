# BMCP Platform - Changelog

## [0.6.0] - 2026-01-10

### Добавлено (Критические исправления по отчёту проверки)
- **ЗАДАЧА 1**: Таблица `executed_step_container_results` (CR-001)
  - Хранение CCA результатов по каждому контейнеру отдельно
  - Поддержка ALCOA+ трейсабильности
  - Статусы: pending, passed, failed, blocked
- **ЗАДАЧА 2**: Множественные группы контейнеров при пассировании
  - Кнопка "+ Добавить группу" для создания комбинаций (напр. 3×T75 + 2×T25)
  - Расчёт общей площади и split ratio по группам
  - Поддержка scale-down для тестирования согласно ТЗ
- **ЗАДАЧА 3**: Edge Function `validate-cca`
  - Автоматическая CCA валидация после сохранения данных
  - Блокировка контейнеров при fail (quality_hold='system')
  - Создание Deviation и задачи для QP
- **ЗАДАЧА 6**: Поля `tissue_types`, `cell_types` в `process_templates`
- **ЗАДАЧА 7**: Поля `at_risk`, `at_risk_reason`, `at_risk_set_at` в `cultures`

### Проверено (уже реализовано)
- **ЗАДАЧА 4**: Редактирование серологии (DonorDetail.tsx - openSerologyModal)
- **ЗАДАЧА 5**: ProcessStepper (ProcessExecution.tsx - строки 613-630)

---

## [0.5.0] - 2026-01-10

### Добавлено (UX улучшения)
- **UX-1**: Расчёт общей площади при пассировании (см², индикация Scale-up)
- **UX-2**: Предупреждение о смене типа контейнера при пассировании
- **UX-3**: Quick actions в карточке культуры (⚡ Пассировать, Заморозить, Разморозить)
- **UX-4**: Empty state для контейнеров ("Контейнеры ещё не созданы")
- **UX-5**: Индикация критических шагов (красный маркер в stepper, бейдж "КРИТИЧЕСКИЙ")

---

## [0.4.0] - 2026-01-10

### Добавлено
- **CONTAINER-001**: Создание культуры с множественными контейнерами
  - Поле "Количество" в форме создания культуры
  - Batch insert контейнеров (P0-1, P0-2, ...)
- **CONTAINER-002**: Гибкое масштабирование при пассировании
  - Выбор типа дочерних контейнеров (scale-up/scale-down)
  - Указание количества дочерних контейнеров
- **FORM-002**: UI редактирования серологии
  - Модальное окно в карточке донора
  - Редактирование HIV/HBV/HCV/Syphilis статусов
- **Users**: Модальное окно создания/редактирования пользователя
- **Settings**: Детальные настройки уведомлений по типам событий
  - Отклонения, новые культуры, результаты QC, одобрения, истекающие партии
- **Seed Data**: Заполнены process_template_steps для основных процессов
  - Пассирование (8 шагов)
  - Криоконсервация (5 шагов)
  - Размораживание (6 шагов)
  - Выделение МСК из жировой ткани (7 шагов)
  - QC Подсчёт (4 шага)
  - QC FACS (4 шага)

### Исправлено
- Соответствие ТЗ в модулях Users и Settings

---

## [0.3.0] - 2026-01-10

### Добавлено
- **Кнопка "Начать процесс"** на странице культуры с dropdown выбором шаблона
- **Stepper визуализация** всех шагов процесса с индикацией статуса
- **Специализированные формы шагов**:
  - `CellCountingForm` — таблица контейнеров, быстрый ввод "Применить ко всем"
  - `MediaChangeForm` — выбор партии среды, расчёт PDT
  - `BankingForm` — тип банка MCB/WCB, параметры криоконсервации
- Роутинг форм по `step_type` в ProcessExecution
- Индикация критических шагов (красный бейдж)
- Автоматический переход к следующему шагу после завершения

### Исправлено
- **BLOCKER #1**: Добавлена кнопка запуска процесса
- **BLOCKER #2**: Загрузка всех шагов (удалён .limit(1))
- **BLOCKER #3**: Специализированные формы вместо generic
- **BLOCKER #4**: Автопереход между шагами

---

## [0.2.0] - 2026-01-10

### Добавлено
- `useAuth` hook для динамического получения user_id
- `getCurrentUserId()` функция для insert/update операций
- Логирование истории контейнеров (`logContainerHistory`) при операциях
- Поля банкирования: криосреда, скорость заморозки, температура хранения
- Поля размораживания: метод, длительность, жизнеспособность после оттаивания

### Исправлено
- **КРИТИЧНО**: Foreign key constraint - изменён default user_id с 1 на 2
- FORM-001: Донация - collection_site, consent_form_number, created_by
- FORM-003: Культура - culture_type, isolation_date, at_risk
- FORM-008: CAPA в Deviation - root_cause, corrective_action, preventive_action
- DATA-001: Динамический *_by_user_id во всех формах
- DATA-002: Обновление container.status после операций
- DATA-003: Обновление container.volume_ml при использовании
- DATA-004: Запись container_history при операциях

---

## [0.1.0] - 2026-01-09

### Добавлено
- **Серология**: Поля HIV/HBV/HCV/Сифилис в форме донации и БД
- **Таймеры процессов**: Обратный отсчёт времени при выполнении шагов
- **Telegram-уведомления**: Интеграция отправки уведомлений при завершении шагов
- **QR-сканер**: Компонент для сканирования оборудования (камера + ручной ввод)
- **FEFO-логика**: Утилита сортировки материалов по сроку годности
- **Справочники**: Полный набор СОПов, процессов, оборудования, локаций

### Изменено
- Миграция БД: добавлена колонка `telegram_chat_id` в таблицу `users`
- Обновлены TypeScript типы из Supabase

### Исправлено
- Корректная типизация для категорий инвентаря

---

## [0.1.1] - 2026-01-09
### Добавлено
- **Прослеживаемость в карточке культуры**:
  - Визуальная цепочка: Донор → Донация → Культура → Банк
  - Кликабельные ссылки на связанные объекты
  - Информация о среде культивирования
- **Редактирование справочников**:
  - Оборудование: кнопки редактирования и удаления в таблице
  - Модальное окно редактирования существующих записей

### Исправлено
- UI: справочники теперь поддерживают CRUD операции

---

## [0.0.1] - 2026-01-09 (Первый релиз)
### Добавлено
- **Страница настроек**:
  - Ввод Telegram Chat ID для уведомлений
  - Переключатели Telegram/Email уведомлений
  - Инструкция получения Chat ID
- **История культур**:
  - Таблица `culture_history` для логирования изменений
  - Отображение истории на странице культуры
  - Автоматическое логирование пассирования, заморозки, размораживания
- **Версионность**:
  - Отображение версии в sidebar (v0.0.1)
  - Инициализация Git репозитория

### Технические изменения
- Переименован пакет в `bmcp-platform`
- Первый официальный релиз

---

## [0.11.0] - 2026-01-08
### Добавлено
- **Cron уведомления QP**:
  - Edge Function notify-pending-donations
  - Cron job каждый час для проверки донаций >4 часов
  - Telegram уведомления QP пользователям
- **Прослеживаемость (Traceability)**:
  - Поиск по коду культуры или контейнера
  - Визуализация полной цепочки: Культура → Донация → Донор
  - Отображение связанных контейнеров
  - Цветовая кодировка типов объектов

---

## [0.10.3] - 2026-01-08
### Добавлено
- **Журнал изменений (Audit Log)**:
  - Полный просмотр истории изменений
  - Фильтрация по таблицам и поиск
  - Раскрытие деталей: было/стало
  - Привязка к пользователям

---

## [0.10.2] - 2026-01-08
### Добавлено
- **Dashboard расширенные метрики**:
  - Задачи на сегодня (просроченные)
  - Донации ожидающие QP одобрения
  - Материалы с истекающим сроком (7 дней)
  - Цветовая индикация для критических метрик

---

## [0.10.1] - 2026-01-08
### Добавлено
- **Telegram уведомления** (Фаза 10: Интеграции):
  - Edge Function `telegram-notify` для отправки сообщений
  - Утилита `sendTelegramNotification` для фронтенда
  - Шаблоны уведомлений: отклонения, CCA, задачи, сроки годности, партии

---

## [0.10.0] - 2026-01-08
### Добавлено
- **QR-коды** (Фаза 10: Интеграции):
  - Компонент QRCodeModal с генерацией, скачиванием PNG и печатью
  - QR-коды для партий сред (CombinedMedia)
  - QR-коды для материалов инвентаря (Inventory)
  - Кнопки QR в таблицах с hover-эффектом

---

## [0.9.4] - 2026-01-08
### Добавлено
- **QP Donation Check** (проверка пригодности донора):
  - Проверка статуса донора (active/eligible)
  - Проверка возраста (18-65 лет)
  - Проверка серологии предыдущих донаций (блок при положительных)
  - Проверка интервала между донациями (мин. 56 дней)
  - Отображение даты последней донации
  - Блокировка создания донации при критических ошибках

---

## [0.9.3] - 2026-01-08
### Добавлено
- **FEFO Валидация при приготовлении сред**:
  - Предупреждение при выборе ингредиента НЕ с ближайшим сроком годности
  - Рекомендация FEFO-оптимального материала с датой истечения
  - Визуальное выделение первого (рекомендуемого) элемента звёздочкой

---

## [0.9.2] - 2026-01-08
### Добавлено
- **QP решения в Deviations**:
  - Модалка выбора решения: Продолжить / Карантин / Утилизация
  - Визуальные карточки с иконками для каждого решения
  - Поле комментария QP для обоснования
- **Автоматические действия по решению QP**:
  - **Продолжить**: закрытие отклонения
  - **Карантин**: установка quality_hold='qp' на контейнер, risk_flag='at_risk' на культуру, создание задачи 'move_to_quarantine'
  - **Утилизация**: статус 'disposed' на контейнер/культуру, создание задачи 'dispose_container'
- Отображение принятого QP решения в списке отклонений

---

## [0.9.1] - 2026-01-08
### Добавлено
- **CCA автопроверка** в ProcessExecution:
  - Поля ввода Viability % и концентрации клеток
  - Автоматическая проверка критериев (viability ≥80%)
  - Поддержка кастомных правил из cca_rules шаблона
- **Автосоздание Deviation при CCA fail**:
  - Автоматическое создание отклонения с типом 'cca_fail'
  - Severity major/critical в зависимости от is_critical шага
  - Привязка к executed_step_id и culture_id
- **Автозадачи для QP**:
  - При CCA fail создаётся задача типа 'investigation'
  - Назначается роли 'qp' с высоким приоритетом
- **Фиксация CCA результатов**:
  - Поля cca_passed и cca_results в executed_steps
  - Статус шага 'failed' при CCA fail

---

## [0.9.0] - 2026-01-08
### Добавлено
- **Таблица tasks**: Новая таблица БД для автозадач
  - Типы: qc_check, move_to_quarantine, dispose_container, investigation, sterility_test, post_thaw_test
  - Приоритеты: low, medium, high, critical
  - Статусы: pending, in_progress, completed, cancelled
- **Страница Задачи** (Tasks.tsx):
  - Список задач с фильтрами по статусу
  - Статистика (ожидает, в работе, просрочено, завершено)
  - Индикация просроченных задач
  - Создание новых задач
  - Быстрое изменение статуса
- **Страница Заказы** (Orders.tsx):
  - Список заказов клиентов с фильтрами
  - Создание нового заказа (клиент, тип клеток, количество, дата)
  - Приоритеты: стандартный, срочный, критический
  - Смена статуса: received → in_production → ready → delivered
- **Страница Выдачи** (Releases.tsx):
  - Список выдач с привязкой к заказам и культурам
  - QP утверждение выдачи
  - Статусы: pending_qp → approved → released
  - Связь с Certificate of Analysis

---

## [0.8.0] - 2026-01-08
### Добавлено
- **Размораживание**: Wizard восстановления культуры из криовиал
  - Выбор замороженных контейнеров
  - Создание активных контейнеров из размороженных
  - Автоматическое обновление статуса культуры

---

## [0.7.0] - 2026-01-08
### Добавлено
- **Банкирование (заморозка)**: Wizard создания MCB/WCB
  - Выбор типа банка (MCB/WCB)
  - Указание количества криовиал
  - Заморозка контейнеров
  - Обновление статуса культуры при полной заморозке

---

## [0.6.2] - 2026-01-08
### Добавлено
- **Пассирование**: Wizard в карточке культуры
  - Выбор контейнеров для пассирования
  - Коэффициент разведения (1:2, 1:3, 1:4, 1:5)
  - Автоматическое создание новых контейнеров P+1
  - Утилизация исходных контейнеров
  - Инкремент current_passage культуры

---

## [0.6.1] - 2026-01-08
### Добавлено
- **QC Тесты**: Полный модуль тестов качества
  - Типы: стерильность, микоплазма, жизнеспособность, идентичность, эффективность, эндотоксины
  - Статусы: pending → in_progress → pass/fail/inconclusive
  - Ввод результатов

---

## [0.6.0] - 2026-01-08
### Добавлено
- **Отклонения (CAPA)**: Полный GMP-модуль
  - Регистрация отклонений (типы: CCA Fail, Контаминация, Отказ оборудования, Документация)
  - Критичность: minor/major/critical
  - Статусы: open → under_review → resolved/escalated
  - CAPA: корневая причина, корректирующие и предупреждающие действия

---

## [0.5.3] - 2026-01-08
### Добавлено
- **Выполнение процессов**: Модуль запуска и выполнения шагов
  - Список выполняемых процессов
  - Wizard запуска нового процесса
  - Выполнение шагов по порядку
  - Статусы: in_progress → completed

---

## [0.5.2] - 2026-01-08
### Добавлено
- **Шаблоны процессов**: Модуль управления шаблонами
  - CRUD шаблонов процессов
  - Управление шагами (step_order, action_type, duration_minutes)
  - Привязка СОПов к шагам

---

## [0.5.1] - 2026-01-08
### Исправлено (по результатам сверки с ТЗ)
- **Комбинированные среды**: Переработан процесс создания партии
  - Добавлен 3-шаговый wizard (Рецепт → Ингредиенты → Подтверждение)
  - Выбор ингредиентов из инвентаря по FEFO
  - Автоматическое списание количества из inventory_items
  - Запись в combined_media_batch_components (прослеживаемость)
  - Создание транзакций в inventory_transactions
  - Smart Search (нормализация названий типа Penicillin-Streptomycin)
  - Auto-Calc (расчёт объёма из % рецепта)
  - Smart Expiry (минимальный срок годности компонентов)
- **QP одобрение донаций**: Добавлены кнопки в карточке донора

---

## [0.5.0] - 2026-01-08
### Добавлено
- **Культуры**: Полный модуль управления культурами
  - Список культур с фильтрами по статусу
  - Создание культуры из одобренной донации
  - Карточка культуры с контейнерами по пассажам
  - Отображение Risk Flag с причиной

---

## [0.4.0] - 2026-01-08
### Добавлено
- **Инвентарь**: CRUD для материалов и реагентов, FEFO сортировка
- **Рецепты сред**: Создание рецептов с компонентами
- **Комбинированные среды**: Управление партиями готовых сред

### Изменено
- Донации: динамические единицы измерения (мл для жидких, г для солидных тканей)
- Донор: полная дата рождения + расчёт возраста
- Добавлен тип ткани "Пупочный канатик"

---

## [0.3.0-legacy] - 2026-01-07
### Добавлено
- **Доноры**: Регистрация с ФИО, контактами, мед. данными
- **Донации**: Создание донации с серологией и договором
- **Карточка донора**: Просмотр донора с его донациями

---

## [0.2.0-legacy] - 2026-01-06
### Добавлено
- **Справочники**:
  - Локации с иерархией
  - Типы контейнеров
  - Оборудование с калибровкой
  - СОПы
  - Пользователи с ролями

---

## [0.1.0-legacy] - 2026-01-05
### Добавлено
- Инициализация проекта
- 28 таблиц в Supabase
- Авторизация (Login, ProtectedRoute)
- Базовый каркас приложения
- Dashboard placeholder
