# Инструкция по применению миграций БД

## Проблема
Миграции в папке `supabase/migrations/` не применяются автоматически при деплое на Vercel. Их нужно выполнить вручную в Supabase Dashboard.

## Как применить миграции

### Вариант 1: Через Supabase Dashboard (рекомендуется)

1. Откройте [Supabase Dashboard](https://supabase.com/dashboard)
2. Выберите ваш проект
3. Перейдите в раздел **SQL Editor** (левое меню)
4. Скопируйте содержимое миграций по порядку и выполните:

#### Критические миграции для текущих исправлений:

**1. Миграция 1768500000_fix_process_templates.sql**
- Удаляет старые шаблоны процессов
- Создаёт 6 новых шаблонов с правильными step_type:
  - Выделение клеток из костного мозга (9 шагов)
  - Выделение клеток из жировой ткани (11 шагов)
  - Пассирование культуры v2.0 (10 шагов)
  - Создание клеточного банка v2.0 (8 шагов)
  - Размораживание v2.0 (8 шагов)
  - Смена среды (4 шага)

**2. Миграция 1768510000_fix_rls_policies_dictionaries.sql**
- Добавляет RLS политики для INSERT/UPDATE/DELETE в справочниках
- Исправляет проблему с сохранением данных в:
  - container_types
  - process_templates
  - process_template_steps
  - locations
  - equipment
  - media_recipes

### Вариант 2: Через Supabase CLI

Если у вас установлен Supabase CLI:

```bash
# Перейдите в директорию проекта
cd IBC_LabWorks

# Примените все миграции
supabase db push

# Или примените конкретную миграцию
supabase db execute --file supabase/migrations/1768500000_fix_process_templates.sql
supabase db execute --file supabase/migrations/1768510000_fix_rls_policies_dictionaries.sql
```

## Проверка результата

После применения миграций:

1. **Проверка шаблонов процессов:**
   - Откройте страницу "Процессы" → "Шаблоны процессов"
   - Должно быть видно 6 новых шаблонов
   - При открытии шаблона должны отображаться шаги

2. **Проверка справочников:**
   - Откройте любой справочник (Типы контейнеров, Локации, и т.д.)
   - Попробуйте создать новую запись
   - Попробуйте отредактировать существующую запись
   - Изменения должны сохраняться без ошибок

3. **Проверка процессов в карточке культуры:**
   - Откройте карточку любой культуры
   - Нажмите кнопку "Начать процесс"
   - Выберите один из шаблонов
   - Должны отображаться все шаги процесса

## Порядок применения всех миграций

Если база данных пустая, применяйте миграции в следующем порядке (по номеру в имени файла):

1. Все миграции до 1768500000
2. `1768500000_fix_process_templates.sql` - Шаблоны процессов
3. `1768510000_fix_rls_policies_dictionaries.sql` - RLS политики для справочников

## Откат миграций

Если что-то пошло не так, можно откатить изменения:

```sql
-- Откат шаблонов процессов
DELETE FROM process_templates WHERE template_code IN (
  'PROC-BM-ISOLATION-V1',
  'PROC-ADIPOSE-ISOLATION-V1',
  'PROC-PASSAGE-V2',
  'PROC-BANKING-V2',
  'PROC-THAWING-V2',
  'PROC-MEDIA-CHANGE-V1'
);

-- Откат RLS политик
-- (Удалить созданные политики через Dashboard → Authentication → Policies)
```

## Контакты

Если возникли проблемы с миграциями, проверьте:
- Логи ошибок в Supabase Dashboard → Logs
- Таблицы существуют и имеют правильную структуру
- RLS включен на таблицах (должен быть enabled)
